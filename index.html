<!DOCTYPE html>
<!-- saved from url=(0055)file:///Users/pro/Downloads/opentimestamps-stamper.html -->
<html lang="fr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>OpenTimestamps - Horodatage de fichiers</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 10px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }

        h1 {
            color: #1f2937;
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: 700;
        }

        .subtitle {
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            background: #f9fafb;
            touch-action: manipulation;
            min-height: 120px;
        }

        .upload-area:hover {
            background: #f1f5f9;
            border-color: #3b82f6;
        }

        .upload-area.dragover {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #666;
            margin-bottom: 10px;
        }

        #fileInput {
            display: none;
        }

        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s;
            width: 100%;
            margin-top: 10px;
            min-height: 44px;
            touch-action: manipulation;
        }

        .btn:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .info-box {
            background: #f9fafb;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
            border: 1px solid #e5e7eb;
        }

        .info-box.show {
            display: block;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .info-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .info-label {
            font-weight: 600;
            color: #333;
        }

        .info-value {
            color: #666;
            word-break: break-all;
            text-align: right;
            max-width: 60%;
            font-family: monospace;
            font-size: 12px;
        }

        .status {
            padding: 10px 20px;
            border-radius: 5px;
            margin-top: 15px;
            text-align: center;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-info {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .file-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .file-size {
            color: #666;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e5e7eb;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s ease;
            touch-action: manipulation;
            min-height: 44px;
        }

        .tab:hover {
            color: #3b82f6;
            background: #f9fafb;
        }

        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .verification-result {
            background: #f9fafb;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
            border: 1px solid #e5e7eb;
        }

        .verification-result.show {
            display: block;
        }

        .verification-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .verification-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .verification-value {
            color: #666;
            font-family: monospace;
            font-size: 13px;
        }

        .upload-small {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            background: #f9fafb;
            touch-action: manipulation;
            min-height: 80px;
        }

        .upload-small:hover {
            background: #f1f5f9;
            border-color: #3b82f6;
        }

        .upload-small.dragover {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .upload-small .upload-icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .upload-small .upload-text {
            color: #666;
            font-size: 14px;
        }

        .input-mode-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 10px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s ease;
            touch-action: manipulation;
            min-height: 44px;
        }

        .mode-btn:hover {
            color: #3b82f6;
        }

        .mode-btn.active {
            background: white;
            color: #3b82f6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .text-input-area {
            display: none;
            margin-bottom: 20px;
        }

        .text-input-area.show {
            display: block;
        }

        .text-input-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: block;
        }

        .text-input {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.2s ease;
            background: #ffffff;
        }

        .text-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .char-counter {
            text-align: right;
            color: #999;
            font-size: 12px;
            margin-top: 5px;
        }

        /* Styles pour la biblioth√®que */
        .library-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .library-item {
            background: #f9fafb;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #3b82f6;
            position: relative;
            border: 1px solid #e5e7eb;
        }

        .library-item.outdated {
            border-left-color: #f59e0b;
            background: #fef3c7;
            border-color: #fde68a;
        }

        .library-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .library-item-title {
            font-weight: 600;
            color: #333;
            font-size: 16px;
            word-break: break-word;
            flex: 1;
        }

        .library-item-date {
            color: #999;
            font-size: 12px;
            margin-top: 5px;
        }

        .library-item-hash {
            font-family: monospace;
            font-size: 12px;
            color: #666;
            background: white;
            padding: 8px;
            border-radius: 5px;
            margin: 10px 0;
            word-break: break-all;
        }

        .library-item-block {
            font-size: 14px;
            color: #333;
            background: #d1fae5;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #10b981;
        }

        .library-item-block a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 600;
            font-family: monospace;
        }

        .library-item-block a:hover {
            text-decoration: underline;
        }

        .library-item-block small {
            color: #666;
            display: block;
            margin-top: 5px;
        }

        .library-item-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .library-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            flex: 1;
            min-width: 120px;
            min-height: 44px;
            touch-action: manipulation;
        }

        .library-btn.download {
            background: #3b82f6;
            color: white;
        }

        .library-btn.download:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .library-btn.download:active {
            transform: translateY(0);
        }

        .library-btn.update {
            background: #f59e0b;
            color: white;
        }

        .library-btn.update:hover {
            background: #d97706;
            transform: translateY(-1px);
        }

        .library-btn.update:active {
            transform: translateY(0);
        }

        .library-btn.verify {
            background: #10b981;
            color: white;
        }

        .library-btn.verify:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .library-btn.verify:active {
            transform: translateY(0);
        }

        .library-btn.delete {
            background: #ef4444;
            color: white;
        }

        .library-btn.delete:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .library-btn.delete:active {
            transform: translateY(0);
        }

        .library-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .library-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }

        .library-status.updated {
            background: #d1fae5;
            color: #065f46;
        }

        .library-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .library-status.checking {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Responsive Mobile */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                align-items: flex-start;
                padding-top: 20px;
            }

            .container {
                padding: 24px 20px;
                border-radius: 12px;
                margin: 0 auto;
            }

            h1 {
                font-size: 24px;
            }

            .subtitle {
                font-size: 13px;
            }

            .tabs {
                gap: 0;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab {
                padding: 10px 16px;
                font-size: 14px;
                white-space: nowrap;
                flex-shrink: 0;
            }

            .upload-area {
                padding: 30px 20px;
            }

            .upload-icon {
                font-size: 40px;
            }

            .upload-text {
                font-size: 14px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 15px;
            }

            .input-mode-selector {
                flex-direction: column;
                gap: 8px;
                padding: 8px;
            }

            .mode-btn {
                padding: 12px 20px;
            }

            .info-box {
                padding: 15px;
            }

            .info-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .info-value {
                max-width: 100%;
                text-align: left;
                font-size: 11px;
            }

            .text-input {
                min-height: 120px;
                padding: 12px;
                font-size: 14px;
            }

            /* Biblioth√®que mobile */
            .library-header > div {
                flex-direction: column !important;
            }

            .library-header .btn {
                width: 100%;
            }

            .library-item {
                padding: 15px;
            }

            .library-item-title {
                font-size: 15px;
            }

            .library-item-date {
                font-size: 11px;
            }

            .library-item-hash {
                font-size: 10px;
                padding: 10px 8px;
            }

            .library-item-actions {
                flex-direction: column;
                gap: 8px;
            }

            .library-btn {
                width: 100%;
                min-width: auto;
                font-size: 14px;
            }

            .library-status {
                display: block;
                margin-left: 0;
                margin-top: 8px;
                text-align: center;
            }

            .library-item-header {
                flex-direction: column;
            }

            /* V√©rification mobile */
            .verification-item {
                padding: 12px;
            }

            .verification-label {
                font-size: 13px;
            }

            .verification-value {
                font-size: 12px;
            }

            .upload-small {
                padding: 15px;
            }

            .upload-small .upload-icon {
                font-size: 28px;
            }

            .upload-small .upload-text {
                font-size: 13px;
            }

            .file-info {
                padding: 12px;
            }

            .file-name {
                font-size: 14px;
            }

            .file-size {
                font-size: 13px;
            }

            .status {
                padding: 8px 15px;
                font-size: 14px;
            }
        }

        /* Tr√®s petits √©crans */
        @media (max-width: 375px) {
            .container {
                padding: 20px 15px;
            }

            h1 {
                font-size: 22px;
            }

            .tab {
                padding: 10px 12px;
                font-size: 13px;
            }

            .library-item-hash {
                font-size: 9px;
            }

            .btn {
                font-size: 14px;
                padding: 10px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê OpenTimestamps</h1>
        <p class="subtitle">Horodatez vos fichiers sur la blockchain Bitcoin</p>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(&#39;stamp&#39;)">Cr√©er un horodatage</button>
            <button class="tab" onclick="switchTab(&#39;verify&#39;)">V√©rifier un horodatage</button>
            <button class="tab" onclick="switchTab(&#39;library&#39;)">üìö Ma biblioth√®que</button>
        </div>

        <!-- Section Cr√©ation d'horodatage -->
        <div id="stampContent" class="tab-content active">
            <div class="input-mode-selector">
                <button class="mode-btn active" onclick="switchInputMode(&#39;file&#39;)">üìÅ Fichier</button>
                <button class="mode-btn" onclick="switchInputMode(&#39;text&#39;)">‚úçÔ∏è Texte</button>
            </div>

            <div id="fileInputArea" class="file-input-area">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Cliquez ici ou glissez-d√©posez un fichier</div>
                    <div style="color: #999; font-size: 12px; margin-top: 5px;">Tout type de fichier accept√©</div>
                </div>

                <input type="file" id="fileInput" accept="*/*">
            </div>

            <div id="textInputArea" class="text-input-area">
                <label class="text-input-label">Entrez votre texte √† horodater:</label>
                <textarea id="textInput" class="text-input" placeholder="Tapez votre texte ici..."></textarea>
                <div class="char-counter" id="charCounter">0 caract√®res</div>
            </div>

            <div class="file-info" id="fileInfo">
                <div class="file-name" id="fileName"></div>
                <div class="file-size" id="fileSize"></div>
            </div>

            <button class="btn" id="stampBtn" disabled="">Cr√©er l'horodatage</button>

            <div class="info-box" id="infoBox">
                <div class="info-row">
                    <span class="info-label">Hash SHA-256:</span>
                    <span class="info-value" id="hashValue"></span>
                </div>
            </div>

            <div id="statusMessage"></div>
        </div>

        <!-- Section V√©rification d'horodatage -->
        <div id="verifyContent" class="tab-content">
            <div class="upload-small" id="uploadOtsArea">
                <div class="upload-icon">üìú</div>
                <div class="upload-text">Cliquez ou glissez-d√©posez le fichier .ots</div>
            </div>
            <input type="file" id="otsFileInput" accept=".ots" style="display: none;">

            <div class="file-info" id="otsFileInfo">
                <div class="file-name" id="otsFileName"></div>
                <div class="file-size" id="otsFileSize"></div>
            </div>

            <div class="upload-small" id="uploadOriginalArea">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">Cliquez ou glissez-d√©posez le fichier original</div>
            </div>
            <input type="file" id="originalFileInput" accept="*/*" style="display: none;">

            <div class="file-info" id="originalFileInfo">
                <div class="file-name" id="originalFileName"></div>
                <div class="file-size" id="originalFileSize"></div>
            </div>

            <button class="btn" id="verifyBtn" disabled="">V√©rifier l'horodatage</button>

            <div class="verification-result" id="verificationResult"></div>

            <div id="verifyStatusMessage"></div>
        </div>

        <!-- Section Biblioth√®que -->
        <div id="libraryContent" class="tab-content">
            <div class="library-header">
                <h2 style="font-size: 20px; color: #333; margin-bottom: 15px;">üìö Mes fichiers horodat√©s</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn" onclick="refreshLibrary()" style="flex: 1; min-width: 120px;">üîÑ Actualiser</button>
                    <button class="btn" onclick="importOtsFile()" style="flex: 1; min-width: 120px; background: #8b5cf6;">üìú Importer .ots</button>
                    <button class="btn" onclick="exportLibrary()" style="flex: 1; min-width: 120px; background: #10b981;">üíæ Sauvegarder</button>
                    <button class="btn" onclick="importLibrary()" style="flex: 1; min-width: 120px; background: #f59e0b;">üìÇ Restaurer</button>
                </div>
                <input type="file" id="importFileInput" accept=".json" style="display: none;">
                <input type="file" id="importOtsFileInput" accept=".ots" style="display: none;">
            </div>

            <div id="libraryList" class="library-list">
                <!-- Les entr√©es seront ajout√©es ici dynamiquement -->
            </div>

            <div id="emptyLibrary" class="status info" style="text-align: center; margin-top: 20px;">
                Aucun fichier horodat√© dans votre biblioth√®que. Cr√©ez votre premier horodatage !
            </div>
        </div>
    </div>

    <script src="opentimestamps.min.js"></script>
    <script>
        // Fonction pour basculer entre les onglets
        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));

            if (tab === 'stamp') {
                tabs[0].classList.add('active');
                document.getElementById('stampContent').classList.add('active');
            } else if (tab === 'verify') {
                tabs[1].classList.add('active');
                document.getElementById('verifyContent').classList.add('active');
            } else if (tab === 'library') {
                tabs[2].classList.add('active');
                document.getElementById('libraryContent').classList.add('active');
                loadLibrary();
            }
        }

        // ============ ANALYSE BINAIRE DES FICHIERS OTS ============

        // Tag d'attestation Bitcoin dans les fichiers OTS
        const BITCOIN_ATTESTATION_TAG = [0x05, 0x88, 0x96, 0x0d, 0x73, 0xd7, 0x19, 0x01];

        // Lire un varint depuis un tableau de bytes √† partir d'une position
        function readVarint(bytes, offset) {
            let value = 0;
            let shift = 0;
            let pos = offset;

            while (pos < bytes.length) {
                const byte = bytes[pos];
                value |= (byte & 0x7f) << shift;
                pos++;
                if ((byte & 0x80) === 0) {
                    break;
                }
                shift += 7;
            }

            return { value, nextOffset: pos };
        }

        // Extraire les infos de bloc depuis les bytes d'un fichier OTS
        function extractBlockInfoFromOtsBytes(otsBytes) {
            // Debug: afficher les premiers et derniers bytes du fichier
            console.log('OTS file size:', otsBytes.length);
            console.log('First 100 bytes (hex):', Array.from(otsBytes.slice(0, 100)).map(b => b.toString(16).padStart(2, '0')).join(' '));
            console.log('Last 50 bytes (hex):', Array.from(otsBytes.slice(-50)).map(b => b.toString(16).padStart(2, '0')).join(' '));

            // Chercher le tag d'attestation Bitcoin dans le fichier
            console.log('Searching for Bitcoin attestation tag:', BITCOIN_ATTESTATION_TAG.map(b => b.toString(16).padStart(2, '0')).join(' '));

            for (let i = 0; i <= otsBytes.length - BITCOIN_ATTESTATION_TAG.length - 4; i++) {
                let found = true;
                for (let j = 0; j < BITCOIN_ATTESTATION_TAG.length; j++) {
                    if (otsBytes[i + j] !== BITCOIN_ATTESTATION_TAG[j]) {
                        found = false;
                        break;
                    }
                }

                if (found) {
                    console.log('Bitcoin attestation tag found at offset:', i);
                    // Tag trouv√©! Apr√®s le tag, il y a un byte de longueur puis la hauteur en varint
                    const lengthByteOffset = i + BITCOIN_ATTESTATION_TAG.length;
                    const dataLength = otsBytes[lengthByteOffset];
                    console.log('Data length byte:', dataLength);

                    // Lire la hauteur du bloc (varint) apr√®s le byte de longueur
                    const heightResult = readVarint(otsBytes, lengthByteOffset + 1);
                    const blockHeight = heightResult.value;
                    console.log('Block height read:', blockHeight);

                    // La hauteur du bloc doit √™tre raisonnable (> 0 et < 10 millions)
                    if (blockHeight > 0 && blockHeight < 10000000) {
                        return {
                            height: blockHeight,
                            timestamp: null // Le timestamp n'est pas stock√© directement, on pourrait le r√©cup√©rer via API
                        };
                    }
                }
            }

            console.log('No Bitcoin attestation found in file');
            return null; // Pas d'attestation Bitcoin trouv√©e
        }

        // ============ GESTION DE LA BIBLIOTH√àQUE LOCALE ============

        const OTS_STORAGE_KEY = 'opentimestamps_library';

        // R√©cup√©rer la biblioth√®que depuis localStorage
        function getLibrary() {
            try {
                const data = localStorage.getItem(OTS_STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error('Erreur lors de la lecture de la biblioth√®que:', error);
                return [];
            }
        }

        // Sauvegarder la biblioth√®que dans localStorage
        function saveLibrary(library) {
            try {
                localStorage.setItem(OTS_STORAGE_KEY, JSON.stringify(library));
            } catch (error) {
                console.error('Erreur lors de la sauvegarde de la biblioth√®que:', error);
            }
        }

        // Ajouter un fichier √† la biblioth√®que
        function addToLibrary(fileName, hash, otsBytes, isTextFile = false) {
            const library = getLibrary();

            // Convertir otsBytes en Array pour pouvoir le stocker en JSON
            const otsArray = Array.from(otsBytes);

            const entry = {
                id: Date.now() + Math.random(), // ID unique
                fileName: fileName,
                hash: hash,
                otsData: otsArray,
                createdAt: new Date().toISOString(),
                isTextFile: isTextFile,
                isUpToDate: false // Par d√©faut, consid√©r√© comme non mis √† jour
            };

            library.push(entry);
            saveLibrary(library);

            return entry;
        }

        // Supprimer un fichier de la biblioth√®que
        function removeFromLibrary(id) {
            let library = getLibrary();
            library = library.filter(entry => String(entry.id) !== String(id));
            saveLibrary(library);
        }

        // Mettre √† jour le statut d'un fichier
        function updateLibraryEntryStatus(id, isUpToDate, updatedOtsData = null, blockInfo = null) {
            const library = getLibrary();
            const entry = library.find(e => e.id === id);

            if (entry) {
                entry.isUpToDate = isUpToDate;
                if (updatedOtsData) {
                    entry.otsData = Array.from(updatedOtsData);
                    entry.lastUpdated = new Date().toISOString();
                }
                if (blockInfo) {
                    entry.blockHeight = blockInfo.height;
                    entry.blockTimestamp = blockInfo.timestamp;
                }
                saveLibrary(library);
            }
        }

        // Charger et afficher la biblioth√®que
        function loadLibrary() {
            const library = getLibrary();
            const libraryList = document.getElementById('libraryList');
            const emptyLibrary = document.getElementById('emptyLibrary');

            if (library.length === 0) {
                libraryList.innerHTML = '';
                emptyLibrary.style.display = 'block';
                return;
            }

            emptyLibrary.style.display = 'none';

            // Trier par date de cr√©ation (plus r√©cent en premier)
            library.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            libraryList.innerHTML = library.map(entry => {
                const createdDate = new Date(entry.createdAt).toLocaleDateString('fr-FR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const statusBadge = entry.isUpToDate
                    ? '<span class="library-status updated">‚úÖ √Ä jour</span>'
                    : '<span class="library-status pending">‚è≥ En attente</span>';

                const updateBtn = !entry.isUpToDate
                    ? `<button class="library-btn update" onclick="checkAndUpdateOts('${entry.id}')">üîÑ V√©rifier & MAJ</button>`
                    : '';

                // Afficher le lien vers le bloc si disponible
                let blockInfo = '';
                if (entry.blockHeight) {
                    const blockDate = entry.blockTimestamp
                        ? new Date(entry.blockTimestamp * 1000).toLocaleDateString('fr-FR', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })
                        : '';
                    const blockExplorerUrl = `https://www.blockchain.com/btc/block-height/${entry.blockHeight}`;
                    blockInfo = `
                        <div class="library-item-block">
                            <strong>‚õìÔ∏è Bloc Bitcoin:</strong>
                            <a href="${blockExplorerUrl}" target="_blank" rel="noopener noreferrer">
                                #${entry.blockHeight} üîó
                            </a>
                            ${blockDate ? `<br><small>Horodat√© le ${blockDate}</small>` : ''}
                        </div>
                    `;
                }

                return `
                    <div class="library-item ${entry.isUpToDate ? '' : 'outdated'}" id="library-item-${entry.id}">
                        <div class="library-item-header">
                            <div>
                                <div class="library-item-title">
                                    üìÑ ${entry.fileName}
                                    ${statusBadge}
                                </div>
                                <div class="library-item-date">Cr√©√© le ${createdDate}</div>
                            </div>
                        </div>
                        <div class="library-item-hash">
                            <strong>Hash SHA-256:</strong><br>
                            ${entry.hash}
                        </div>
                        ${blockInfo}
                        <div class="library-item-actions">
                            <button class="library-btn download" onclick="downloadOtsFromLibrary('${entry.id}')">
                                üì• T√©l√©charger .ots
                            </button>
                            ${updateBtn}
                            <button class="library-btn delete" onclick="deleteFromLibrary('${entry.id}')">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Actualiser la biblioth√®que
        function refreshLibrary() {
            loadLibrary();
        }

        // Exporter la biblioth√®que vers un fichier JSON
        function exportLibrary() {
            const library = getLibrary();

            if (library.length === 0) {
                alert('La biblioth√®que est vide, rien √† sauvegarder.');
                return;
            }

            try {
                // Cr√©er un objet avec m√©tadonn√©es
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    itemCount: library.length,
                    library: library
                };

                // Convertir en JSON
                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });

                // G√©n√©rer un nom de fichier avec la date
                const date = new Date();
                const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
                const timeStr = date.toTimeString().slice(0, 5).replace(':', '');
                const filename = `opentimestamps_library_${dateStr}_${timeStr}.json`;

                // T√©l√©charger le fichier
                downloadFile(blob, filename);

                alert(`‚úÖ Biblioth√®que sauvegard√©e avec succ√®s!\n${library.length} fichier(s) export√©(s).`);
            } catch (error) {
                console.error('Erreur lors de l\'export:', error);
                alert('‚ùå Erreur lors de la sauvegarde: ' + error.message);
            }
        }

        // Importer une biblioth√®que depuis un fichier JSON
        function importLibrary() {
            const importInput = document.getElementById('importFileInput');
            importInput.click();
        }

        // G√©rer la s√©lection du fichier d'import
        document.getElementById('importFileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const importData = JSON.parse(text);

                // V√©rifier la structure des donn√©es
                if (!importData.library || !Array.isArray(importData.library)) {
                    throw new Error('Format de fichier invalide');
                }

                const currentLibrary = getLibrary();
                const importedLibrary = importData.library;

                // Demander confirmation si la biblioth√®que actuelle n'est pas vide
                if (currentLibrary.length > 0) {
                    const confirmMsg = `Voulez-vous fusionner les donn√©es ?\n\n` +
                        `Biblioth√®que actuelle: ${currentLibrary.length} fichier(s)\n` +
                        `Fichier √† importer: ${importedLibrary.length} fichier(s)\n\n` +
                        `OUI = Fusionner (ajouter aux fichiers existants)\n` +
                        `NON = Remplacer (supprimer les fichiers existants)`;

                    const shouldMerge = confirm(confirmMsg);

                    if (shouldMerge) {
                        // Fusionner : √©viter les doublons bas√©s sur le hash
                        const existingHashes = new Set(currentLibrary.map(item => item.hash));
                        const newItems = importedLibrary.filter(item => !existingHashes.has(item.hash));

                        const mergedLibrary = [...currentLibrary, ...newItems];
                        saveLibrary(mergedLibrary);

                        alert(`‚úÖ Biblioth√®que import√©e avec succ√®s!\n` +
                              `${newItems.length} nouveau(x) fichier(s) ajout√©(s).\n` +
                              `${importedLibrary.length - newItems.length} doublon(s) ignor√©(s).`);
                    } else {
                        // Remplacer
                        saveLibrary(importedLibrary);
                        alert(`‚úÖ Biblioth√®que restaur√©e avec succ√®s!\n${importedLibrary.length} fichier(s) import√©(s).`);
                    }
                } else {
                    // Biblioth√®que vide, importer directement
                    saveLibrary(importedLibrary);
                    alert(`‚úÖ Biblioth√®que restaur√©e avec succ√®s!\n${importedLibrary.length} fichier(s) import√©(s).`);
                }

                // Recharger l'affichage
                loadLibrary();

            } catch (error) {
                console.error('Erreur lors de l\'import:', error);
                alert('‚ùå Erreur lors de la restauration: ' + error.message);
            }

            // R√©initialiser l'input pour permettre de r√©importer le m√™me fichier
            e.target.value = '';
        });

        // Importer un fichier .ots directement dans la biblioth√®que
        function importOtsFile() {
            const importOtsInput = document.getElementById('importOtsFileInput');
            importOtsInput.click();
        }

        // G√©rer la s√©lection du fichier .ots √† importer
        document.getElementById('importOtsFileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                // V√©rifier que c'est bien un fichier .ots (taille raisonnable)
                if (file.size > 10 * 1024 * 1024) {
                    throw new Error('Le fichier est trop volumineux pour √™tre un fichier .ots valide');
                }

                // Lire le fichier .ots
                const arrayBuffer = await file.arrayBuffer();
                const otsBytes = new Uint8Array(arrayBuffer);

                // V√©rifier le magic number des fichiers OTS
                // Header: "\x00OpenTimestamps\x00\x00Proof\x00\xbf\x89\xe2\xe8\x84\xe8\x92\x94" (31 bytes)
                const magicHeader = [0x00, 0x4f, 0x70, 0x65, 0x6e, 0x54, 0x69, 0x6d, 0x65, 0x73, 0x74, 0x61, 0x6d, 0x70, 0x73, 0x00, 0x00, 0x50, 0x72, 0x6f, 0x6f, 0x66, 0x00, 0xbf, 0x89, 0xe2, 0xe8, 0x84, 0xe8, 0x92, 0x94];
                const hasMagic = magicHeader.every((byte, i) => otsBytes[i] === byte);
                if (!hasMagic) {
                    throw new Error('Ce fichier ne semble pas √™tre un fichier .ots valide');
                }

                // Extraire le hash directement depuis les bytes
                // Structure apr√®s le header (31 bytes):
                // - 1 byte: version (0x01)
                // - 1 byte: hash type (0x08 = SHA256)
                // - 1 byte: hash length (0x20 = 32)
                // - 32 bytes: le hash SHA256
                const hashStart = 31 + 1 + 1 + 1; // 34
                const hashLength = 32;

                if (otsBytes.length < hashStart + hashLength) {
                    throw new Error('Fichier .ots trop court ou corrompu');
                }

                const hashBytes = otsBytes.slice(hashStart, hashStart + hashLength);
                const hash = Array.from(hashBytes).map(b => b.toString(16).padStart(2, '0')).join('');

                // V√©rifier si ce hash existe d√©j√† dans la biblioth√®que
                const library = getLibrary();
                const existingEntry = library.find(entry => entry.hash === hash);

                if (existingEntry) {
                    alert(`‚ö†Ô∏è Ce fichier est d√©j√† dans la biblioth√®que sous le nom "${existingEntry.fileName}"`);
                    e.target.value = '';
                    return;
                }

                // D√©terminer le nom du fichier original (enlever .ots)
                let originalFileName = file.name;
                if (originalFileName.endsWith('.ots')) {
                    originalFileName = originalFileName.slice(0, -4);
                }

                // Demander confirmation du nom
                const confirmedName = prompt(
                    'Nom du fichier original associ√© √† cet horodatage:',
                    originalFileName
                );

                if (!confirmedName) {
                    e.target.value = '';
                    return;
                }

                // D√©tecter si le fichier est d√©j√† v√©rifi√© (contient une attestation Bitcoin)
                const blockInfo = extractBlockInfoFromOtsBytes(otsBytes);
                const isVerified = blockInfo !== null;

                // Ajouter √† la biblioth√®que
                const entry = addToLibrary(confirmedName, hash, otsBytes, false);

                // Si v√©rifi√©, mettre √† jour le statut avec les infos du bloc
                if (isVerified) {
                    updateLibraryEntryStatus(entry.id, true, null, blockInfo);
                }

                // Recharger l'affichage
                loadLibrary();

                if (isVerified) {
                    alert(`‚úÖ Fichier .ots import√© avec succ√®s!\n‚úÖ V√©rifi√© sur la blockchain Bitcoin (bloc #${blockInfo.height})`);
                } else {
                    alert(`‚úÖ Fichier .ots import√© avec succ√®s!\n‚è≥ En attente de confirmation sur la blockchain`);
                }

            } catch (error) {
                console.error('Erreur lors de l\'import du fichier .ots:', error);
                alert('‚ùå Erreur lors de l\'import: ' + error.message);
            }

            // R√©initialiser l'input
            e.target.value = '';
        });

        // T√©l√©charger un fichier OTS depuis la biblioth√®que
        function downloadOtsFromLibrary(id) {
            const library = getLibrary();
            const entry = library.find(e => e.id == id);

            if (!entry) {
                alert('Fichier non trouv√© dans la biblioth√®que');
                return;
            }

            // Convertir l'array en Uint8Array
            const otsBytes = new Uint8Array(entry.otsData);
            const otsBlob = new Blob([otsBytes], { type: 'application/octet-stream' });

            downloadFile(otsBlob, entry.fileName + '.ots');
        }

        // Extraire les informations du bloc depuis le r√©sultat de v√©rification
        function extractBlockInfo(verifyResult) {
            if (!verifyResult) return null;
            for (const [chain, attestation] of Object.entries(verifyResult)) {
                if (attestation && attestation.height) {
                    return {
                        height: attestation.height,
                        timestamp: attestation.timestamp
                    };
                }
            }
            return null;
        }

        // V√©rifier et mettre √† jour un fichier OTS
        async function checkAndUpdateOts(id) {
            const library = getLibrary();
            const entry = library.find(e => e.id == id);

            if (!entry) {
                alert('Fichier non trouv√© dans la biblioth√®que');
                return;
            }

            const itemElement = document.getElementById(`library-item-${entry.id}`);
            const updateBtn = itemElement.querySelector('.library-btn.update');

            if (updateBtn) {
                updateBtn.disabled = true;
                updateBtn.innerHTML = '<span class="loading"></span> V√©rification...';
            }

            try {
                // Convertir l'array en Uint8Array
                const otsBytes = new Uint8Array(entry.otsData);

                // D'abord, v√©rifier via analyse binaire si d√©j√† confirm√©
                const blockInfo = extractBlockInfoFromOtsBytes(otsBytes);

                if (blockInfo) {
                    // Le fichier contient d√©j√† une attestation Bitcoin
                    updateLibraryEntryStatus(entry.id, true, null, blockInfo);
                    loadLibrary();
                    alert(`‚úÖ Le fichier OTS est confirm√© sur la blockchain!\nBloc #${blockInfo.height}`);
                    return;
                }

                // Pas encore confirm√©, essayer d'upgrader via les serveurs calendrier
                try {
                    const detached = OpenTimestamps.DetachedTimestampFile.deserialize(otsBytes);
                    const changed = await OpenTimestamps.upgrade(detached);

                    if (changed) {
                        // S√©rialiser le fichier mis √† jour
                        const updatedOtsBytes = detached.serializeToBytes();

                        // V√©rifier si maintenant il contient une attestation
                        const newBlockInfo = extractBlockInfoFromOtsBytes(updatedOtsBytes);

                        if (newBlockInfo) {
                            updateLibraryEntryStatus(entry.id, true, updatedOtsBytes, newBlockInfo);
                            loadLibrary();
                            alert(`‚úÖ Le fichier OTS a √©t√© mis √† jour!\nConfirm√© sur le bloc #${newBlockInfo.height}`);
                        } else {
                            updateLibraryEntryStatus(entry.id, false, updatedOtsBytes);
                            loadLibrary();
                            alert('üîÑ Fichier mis √† jour mais pas encore confirm√© sur la blockchain.');
                        }
                    } else {
                        if (updateBtn) {
                            updateBtn.disabled = false;
                            updateBtn.innerHTML = 'üîÑ V√©rifier & MAJ';
                        }
                        alert('‚è≥ Aucune mise √† jour disponible pour le moment. L\'inscription sur la blockchain peut prendre quelques heures.');
                    }
                } catch (upgradeError) {
                    console.error('Erreur lors de l\'upgrade:', upgradeError);
                    if (updateBtn) {
                        updateBtn.disabled = false;
                        updateBtn.innerHTML = 'üîÑ V√©rifier & MAJ';
                    }
                    alert('‚è≥ Aucune mise √† jour disponible pour le moment. R√©essayez plus tard.');
                }
            } catch (error) {
                console.error('Erreur lors de la mise √† jour:', error);
                if (updateBtn) {
                    updateBtn.disabled = false;
                    updateBtn.innerHTML = 'üîÑ V√©rifier & MAJ';
                }
                alert('‚ùå Erreur lors de la mise √† jour: ' + error.message);
            }
        }

        // Supprimer un fichier de la biblioth√®que
        function deleteFromLibrary(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce fichier de la biblioth√®que ?')) {
                removeFromLibrary(id);
                loadLibrary();
            }
        }

        // Fonction pour basculer entre fichier et texte
        function switchInputMode(mode) {
            const modeBtns = document.querySelectorAll('.mode-btn');
            const fileInputArea = document.getElementById('fileInputArea');
            const textInputArea = document.getElementById('textInputArea');

            modeBtns.forEach(btn => btn.classList.remove('active'));

            if (mode === 'file') {
                modeBtns[0].classList.add('active');
                fileInputArea.style.display = 'block';
                textInputArea.classList.remove('show');
                // R√©initialiser le mode texte
                currentInputMode = 'file';
                resetStampForm();
            } else {
                modeBtns[1].classList.add('active');
                fileInputArea.style.display = 'none';
                textInputArea.classList.add('show');
                currentInputMode = 'text';
                resetStampForm();
            }
        }

        // Variables pour la section Cr√©ation
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const textInput = document.getElementById('textInput');
        const charCounter = document.getElementById('charCounter');
        const stampBtn = document.getElementById('stampBtn');
        const infoBox = document.getElementById('infoBox');
        const hashValue = document.getElementById('hashValue');
        const statusMessage = document.getElementById('statusMessage');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');

        let selectedFile = null;
        let fileHash = null;
        let currentInputMode = 'file';
        let textContent = null;

        // Variables pour la section V√©rification
        const uploadOtsArea = document.getElementById('uploadOtsArea');
        const otsFileInput = document.getElementById('otsFileInput');
        const otsFileInfo = document.getElementById('otsFileInfo');
        const otsFileName = document.getElementById('otsFileName');
        const otsFileSize = document.getElementById('otsFileSize');

        const uploadOriginalArea = document.getElementById('uploadOriginalArea');
        const originalFileInput = document.getElementById('originalFileInput');
        const originalFileInfo = document.getElementById('originalFileInfo');
        const originalFileName = document.getElementById('originalFileName');
        const originalFileSize = document.getElementById('originalFileSize');

        const verifyBtn = document.getElementById('verifyBtn');
        const verificationResult = document.getElementById('verificationResult');
        const verifyStatusMessage = document.getElementById('verifyStatusMessage');

        let otsFile = null;
        let originalFile = null;

        // Fonction pour r√©initialiser le formulaire de cr√©ation
        function resetStampForm() {
            selectedFile = null;
            fileHash = null;
            textContent = null;
            infoBox.classList.remove('show');
            fileInfo.classList.remove('show');
            stampBtn.disabled = true;
            statusMessage.innerHTML = '';
            hashValue.textContent = '';
            if (currentInputMode === 'text') {
                textInput.value = '';
                charCounter.textContent = '0 caract√®res';
            }
        }

        // Compteur de caract√®res pour le textarea
        textInput.addEventListener('input', () => {
            const length = textInput.value.length;
            charCounter.textContent = `${length} caract√®re${length > 1 ? 's' : ''}`;

            if (length > 0) {
                handleText(textInput.value);
            } else {
                resetStampForm();
            }
        });

        // Gestion du texte saisi
        async function handleText(text) {
            textContent = text;

            // Afficher le message de calcul du hash
            showStatus('Calcul du hash SHA-256...', 'info');

            try {
                // Calculer le hash du texte
                const encoder = new TextEncoder();
                const data = encoder.encode(text);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                fileHash = hashHex;

                // Afficher le hash
                hashValue.textContent = fileHash;
                infoBox.classList.add('show');

                // Activer le bouton d'horodatage
                stampBtn.disabled = false;

                showStatus('Hash calcul√© avec succ√®s!', 'success');
            } catch (error) {
                console.error('Erreur lors du calcul du hash:', error);
                showStatus('Erreur lors du calcul du hash: ' + error.message, 'error');
            }
        }

        // Gestion du click sur la zone d'upload
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // Gestion du drag & drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // Gestion de la s√©lection de fichier
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Fonction pour calculer le hash SHA-256
        async function calculateSHA256(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const arrayBuffer = e.target.result;
                        const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
                        const hashArray = Array.from(new Uint8Array(hashBuffer));
                        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                        resolve(hashHex);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(reader.error);
                reader.readAsArrayBuffer(file);
            });
        }

        // Gestion du fichier s√©lectionn√©
        async function handleFile(file) {
            selectedFile = file;

            // Afficher les infos du fichier
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.add('show');

            // Afficher le message de calcul du hash
            showStatus('Calcul du hash SHA-256...', 'info');

            try {
                // Calculer le hash
                fileHash = await calculateSHA256(file);

                // Afficher le hash
                hashValue.textContent = fileHash;
                infoBox.classList.add('show');

                // Activer le bouton d'horodatage
                stampBtn.disabled = false;

                showStatus('Hash calcul√© avec succ√®s!', 'success');
            } catch (error) {
                console.error('Erreur lors du calcul du hash:', error);
                showStatus('Erreur lors du calcul du hash: ' + error.message, 'error');
            }
        }

        // Fonction pour formater la taille du fichier
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Fonction pour afficher les messages de statut
        function showStatus(message, type) {
            statusMessage.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // Fonction pour cr√©er l'horodatage
        stampBtn.addEventListener('click', async () => {
            if (!fileHash) return;
            if (currentInputMode === 'file' && !selectedFile) return;
            if (currentInputMode === 'text' && !textContent) return;

            stampBtn.disabled = true;
            showStatus('<span class="loading"></span> Cr√©ation de l\'horodatage en cours...', 'info');

            try {
                // Convertir le hash hexad√©cimal en Uint8Array
                const hashBytes = new Uint8Array(fileHash.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));

                // Cr√©er le timestamp d√©tach√© √† partir du hash
                const detached = OpenTimestamps.DetachedTimestampFile.fromHash(
                    new OpenTimestamps.Ops.OpSHA256(),
                    hashBytes
                );

                // Cr√©er l'horodatage
                await OpenTimestamps.stamp(detached);

                // S√©rialiser le timestamp en bytes
                const otsBytes = detached.serializeToBytes();

                let fileName;
                if (currentInputMode === 'text') {
                    // Mode texte : t√©l√©charger le fichier texte et le fichier .ots
                    const timestamp = new Date().getTime();
                    const baseFileName = `text_${timestamp}`;
                    fileName = `${baseFileName}.txt`;

                    // T√©l√©charger le fichier texte
                    const textBlob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
                    downloadFile(textBlob, fileName);

                    // Attendre un court instant avant le deuxi√®me t√©l√©chargement
                    await new Promise(resolve => setTimeout(resolve, 100));

                    // T√©l√©charger le fichier .ots
                    const otsBlob = new Blob([otsBytes], { type: 'application/octet-stream' });
                    downloadFile(otsBlob, `${fileName}.ots`);

                    // Ajouter √† la biblioth√®que
                    addToLibrary(fileName, fileHash, otsBytes, true);

                    showStatus('‚úÖ Horodatage cr√©√© avec succ√®s! Le fichier texte et le fichier .ots ont √©t√© t√©l√©charg√©s et ajout√©s √† la biblioth√®que.', 'success');
                } else {
                    // Mode fichier : t√©l√©charger uniquement le fichier .ots
                    fileName = selectedFile.name;
                    const otsBlob = new Blob([otsBytes], { type: 'application/octet-stream' });
                    downloadFile(otsBlob, fileName + '.ots');

                    // Ajouter √† la biblioth√®que
                    addToLibrary(fileName, fileHash, otsBytes, false);

                    showStatus('‚úÖ Horodatage cr√©√© avec succ√®s! Le fichier .ots a √©t√© t√©l√©charg√© et ajout√© √† la biblioth√®que.', 'success');
                }

                stampBtn.disabled = false;

            } catch (error) {
                console.error('Erreur lors de l\'horodatage:', error);
                showStatus('‚ùå Erreur lors de l\'horodatage: ' + error.message, 'error');
                stampBtn.disabled = false;
            }
        });

        // Fonction pour t√©l√©charger un fichier
        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ============ SECTION V√âRIFICATION ============

        // Gestion de l'upload du fichier .ots
        uploadOtsArea.addEventListener('click', () => {
            otsFileInput.click();
        });

        // Drag & drop pour le fichier .ots
        uploadOtsArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadOtsArea.classList.add('dragover');
        });

        uploadOtsArea.addEventListener('dragleave', () => {
            uploadOtsArea.classList.remove('dragover');
        });

        uploadOtsArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadOtsArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                otsFile = files[0];
                otsFileName.textContent = otsFile.name;
                otsFileSize.textContent = formatFileSize(otsFile.size);
                otsFileInfo.classList.add('show');
                checkVerifyReady();
            }
        });

        otsFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                otsFile = e.target.files[0];
                otsFileName.textContent = otsFile.name;
                otsFileSize.textContent = formatFileSize(otsFile.size);
                otsFileInfo.classList.add('show');
                checkVerifyReady();
            }
        });

        // Gestion de l'upload du fichier original
        uploadOriginalArea.addEventListener('click', () => {
            originalFileInput.click();
        });

        // Drag & drop pour le fichier original
        uploadOriginalArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadOriginalArea.classList.add('dragover');
        });

        uploadOriginalArea.addEventListener('dragleave', () => {
            uploadOriginalArea.classList.remove('dragover');
        });

        uploadOriginalArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadOriginalArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                originalFile = files[0];
                originalFileName.textContent = originalFile.name;
                originalFileSize.textContent = formatFileSize(originalFile.size);
                originalFileInfo.classList.add('show');
                checkVerifyReady();
            }
        });

        originalFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                originalFile = e.target.files[0];
                originalFileName.textContent = originalFile.name;
                originalFileSize.textContent = formatFileSize(originalFile.size);
                originalFileInfo.classList.add('show');
                checkVerifyReady();
            }
        });

        // V√©rifier si les deux fichiers sont charg√©s
        function checkVerifyReady() {
            if (otsFile && originalFile) {
                verifyBtn.disabled = false;
            }
        }

        // Fonction pour afficher les messages de statut (v√©rification)
        function showVerifyStatus(message, type) {
            verifyStatusMessage.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // Bouton upgrade du fichier .ots
        const upgradeBtn = document.createElement('button');
        upgradeBtn.className = 'btn';
        upgradeBtn.textContent = 'üîÑ Mettre √† jour le timestamp';
        upgradeBtn.style.marginTop = '10px';
        upgradeBtn.style.display = 'none';
        upgradeBtn.addEventListener('click', upgradeOtsFile);
        verifyStatusMessage.parentNode.insertBefore(upgradeBtn, verifyStatusMessage.nextSibling);

        // Fonction pour v√©rifier l'horodatage
        verifyBtn.addEventListener('click', async () => {
            if (!otsFile || !originalFile) return;

            verifyBtn.disabled = true;
            upgradeBtn.style.display = 'none';
            verificationResult.classList.remove('show');
            showVerifyStatus('<span class="loading"></span> V√©rification en cours...', 'info');

            try {
                // Lire le fichier .ots
                const otsArrayBuffer = await readFileAsArrayBuffer(otsFile);
                const otsBytes = new Uint8Array(otsArrayBuffer);

                // Lire le fichier original
                const originalArrayBuffer = await readFileAsArrayBuffer(originalFile);
                const originalBytes = new Uint8Array(originalArrayBuffer);

                // D√©s√©rialiser le fichier .ots
                const detachedOts = OpenTimestamps.DetachedTimestampFile.deserialize(otsBytes);
                currentDetachedOts = detachedOts; // Sauvegarder pour upgrade

                // Cr√©er le DetachedTimestampFile du fichier original
                const detached = OpenTimestamps.DetachedTimestampFile.fromBytes(
                    new OpenTimestamps.Ops.OpSHA256(),
                    originalBytes
                );

                // V√©rifier le timestamp
                const verifyResult = await OpenTimestamps.verify(detachedOts, detached);

                // Afficher les r√©sultats
                if (verifyResult && Object.keys(verifyResult).length > 0) {
                    displayVerificationResults(verifyResult);

                    // V√©rifier s'il y a une mise √† jour disponible
                    showVerifyStatus('<span class="loading"></span> V√©rification des mises √† jour disponibles...', 'info');
                    const changed = await OpenTimestamps.upgrade(currentDetachedOts);

                    if (changed) {
                        showVerifyStatus('‚úÖ Horodatage v√©rifi√© avec succ√®s! Une mise √† jour du fichier .ots est disponible.', 'success');
                        upgradeBtn.textContent = 'üì• T√©l√©charger le fichier .ots mis √† jour';
                        upgradeBtn.style.display = 'block';
                    } else {
                        showVerifyStatus('‚úÖ Horodatage v√©rifi√© avec succ√®s! Le fichier .ots est d√©j√† √† jour.', 'success');
                        upgradeBtn.style.display = 'none';
                    }
                } else {
                    // V√©rifier s'il y a une mise √† jour disponible m√™me sans v√©rification r√©ussie
                    try {
                        const changed = await OpenTimestamps.upgrade(currentDetachedOts);
                        if (changed) {
                            showVerifyStatus('‚è≥ L\'horodatage n\'est pas encore confirm√© sur la blockchain, mais une mise √† jour partielle est disponible.', 'info');
                            upgradeBtn.textContent = 'üì• T√©l√©charger le fichier .ots mis √† jour';
                            upgradeBtn.style.display = 'block';
                        } else {
                            showVerifyStatus('‚è≥ L\'horodatage n\'est pas encore confirm√© sur la blockchain. Il peut prendre quelques heures pour √™tre confirm√©. Revenez plus tard pour v√©rifier les mises √† jour.', 'info');
                            upgradeBtn.style.display = 'none';
                        }
                    } catch (upgradeError) {
                        console.error('Erreur lors de la v√©rification de mise √† jour:', upgradeError);
                        showVerifyStatus('‚è≥ L\'horodatage n\'est pas encore confirm√© sur la blockchain. Il peut prendre quelques heures pour √™tre confirm√©. Revenez plus tard pour v√©rifier les mises √† jour.', 'info');
                        upgradeBtn.style.display = 'none';
                    }
                }

                verifyBtn.disabled = false;

            } catch (error) {
                console.error('Erreur lors de la v√©rification:', error);
                showVerifyStatus('‚ùå Erreur lors de la v√©rification: ' + error.message, 'error');
                verifyBtn.disabled = false;
            }
        });

        // Fonction pour lire un fichier comme ArrayBuffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsArrayBuffer(file);
            });
        }

        // Variable globale pour stocker l'objet detached actuel
        let currentDetachedOts = null;

        // Fonction pour afficher les r√©sultats de v√©rification
        function displayVerificationResults(results) {
            let html = '';

            for (const [chain, attestations] of Object.entries(results)) {
                // V√©rifier si attestations est un array, sinon le convertir
                const attestationList = Array.isArray(attestations) ? attestations : [attestations];
                
                attestationList.forEach((attestation, index) => {
                    if (!attestation) return; // Ignorer les valeurs vides
                    
                    const date = new Date(attestation.timestamp * 1000);
                    const blockExplorerUrl = `https://www.blockchain.com/btc/block-height/${attestation.height}`;
                    
                    html += `
                        <div class="verification-item">
                            <div class="verification-label">Blockchain</div>
                            <div class="verification-value">${chain === 'bitcoin' ? 'Bitcoin' : chain}</div>
                        </div>
                        <div class="verification-item">
                            <div class="verification-label">Hauteur de bloc</div>
                            <div class="verification-value">
                                <a href="${blockExplorerUrl}" target="_blank" style="color: #3b82f6; text-decoration: none; font-weight: 600;">
                                    ${attestation.height || 'N/A'} üîó
                                </a>
                            </div>
                        </div>
                        <div class="verification-item">
                            <div class="verification-label">Date et heure</div>
                            <div class="verification-value">${date.toLocaleString('fr-FR', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            })}</div>
                        </div>
                        <div class="verification-item">
                            <div class="verification-label">Timestamp Unix</div>
                            <div class="verification-value">${attestation.timestamp}</div>
                        </div>
                    `;
                });
            }

            verificationResult.innerHTML = html;
            verificationResult.classList.add('show');
        }

        // Fonction pour t√©l√©charger le fichier .ots mis √† jour
        async function upgradeOtsFile() {
            if (!currentDetachedOts) {
                showVerifyStatus('‚ùå Aucun fichier .ots charg√©', 'error');
                return;
            }

            showVerifyStatus('<span class="loading"></span> Pr√©paration du t√©l√©chargement...', 'info');

            try {
                // S√©rialiser le fichier .ots mis √† jour
                const upgradedOts = currentDetachedOts.serializeToBytes();
                const otsBlob = new Blob([upgradedOts], { type: 'application/octet-stream' });

                // G√©n√©rer un nouveau nom de fichier avec "_updated" pour √©viter d'√©craser l'original
                const originalName = otsFile.name;
                const newName = originalName.replace('.ots', '_updated.ots');

                downloadFile(otsBlob, newName);

                showVerifyStatus('‚úÖ Le fichier .ots mis √† jour a √©t√© t√©l√©charg√© avec succ√®s!', 'success');
                upgradeBtn.style.display = 'none';
            } catch (error) {
                console.error('Erreur lors du t√©l√©chargement:', error);
                showVerifyStatus('‚ùå Erreur lors du t√©l√©chargement: ' + error.message, 'error');
            }
        }
    </script>


</body></html>